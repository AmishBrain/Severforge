#!/usr/bin/env bash
# ============================================================
# ğŸ©º Severforge Status Monitor
# Version: 1.0.0
# Authors: Amish ğŸ§  & Pisces âš™ï¸
# ============================================================

# --- INTEGRITY CHECK SECTION ---
CORE_DIR="$HOME/Severforge"
HASH_DIR="$CORE_DIR/config"
mkdir -p "$HASH_DIR"

declare -A CORE_FILES=(
  ["sanitize.sh"]="$CORE_DIR/scripts/sanitize.sh"
  ["evidence_hash.py"]="$CORE_DIR/scripts/evidence_hash.py"
  ["sf_clean"]="$CORE_DIR/scripts/sf_clean"
  ["sf_status"]="$CORE_DIR/scripts/sf_status"
  ["pipeline.sh"]="$CORE_DIR/ops/pipeline.sh"
)

BASELINE="$HASH_DIR/integrity_baseline.txt"
CURRENT_TMP="/tmp/sf_integrity.$$"

# Function: generate current hash list
gen_hash_list() {
  for f in "${CORE_FILES[@]}"; do
    if [ -f "$f" ]; then
      sha256sum "$f"
    else
      echo "MISSING $f"
    fi
  done
}

# First run: create baseline if not present
if [ ! -f "$BASELINE" ]; then
  echo "âš™ï¸  [Integrity] Creating new baseline at $BASELINE"
  gen_hash_list > "$BASELINE"
  echo "âœ… Integrity baseline initialized."
else
  gen_hash_list > "$CURRENT_TMP"
  DIFF_OUTPUT=$(diff -u "$BASELINE" "$CURRENT_TMP" || true)
  if [ -n "$DIFF_OUTPUT" ]; then
    echo "ğŸ”´ Integrity Alert â€” changes detected in core scripts!"
    echo "$DIFF_OUTPUT" | awk '{print "   " $0}'
    INTEGRITY_STATUS="FAIL"
  else
    INTEGRITY_STATUS="OK"
  fi
  rm -f "$CURRENT_TMP"
fi

echo ""
if [ "${INTEGRITY_STATUS:-OK}" = "OK" ]; then
  echo "âœ… Integrity OK â€” all core scripts verified."
else
  echo "âš ï¸  Integrity Mismatch â€” check logs or reset baseline."
fi
echo ""

VERSION_FILE="$HOME/Severforge/version.txt"
LOG_DIR="$HOME/Severforge/logs"
EVIDENCE_DIR="$HOME/Severforge/evidence"
CONFIG_DIR="$HOME/Severforge/config"
STATUS_TMP="/tmp/sf_status.$$"

# --- Colors ---
green=$(printf '\033[32m')
red=$(printf '\033[31m')
yellow=$(printf '\033[33m')
cyan=$(printf '\033[36m')
reset=$(printf '\033[0m')

# --- Header ---
echo ""
echo "â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®"
echo "â”‚      ğŸ”  SEVERFORGE SYSTEM STATUS CHECK       â”‚"
echo "â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯"
echo ""

# --- Version info ---
if [[ -f "$VERSION_FILE" ]]; then
  version=$(cat "$VERSION_FILE")
else
  version="v1.0.0 (untracked)"
fi
echo "ğŸ§© Version: ${cyan}$version${reset}"

# --- Uptime info ---
uptime_str=$(uptime -p)
echo "ğŸ• Uptime: ${green}$uptime_str${reset}"

# --- Log summary ---
log_count=$(find "$LOG_DIR" -type f 2>/dev/null | wc -l | tr -d ' ')
echo "ğŸ“œ Logs present: ${yellow}$log_count${reset}"

# --- Evidence folders ---
ev_count=$(find "$EVIDENCE_DIR" -type d -mindepth 1 2>/dev/null | wc -l | tr -d ' ')
echo "ğŸ§¾ Evidence sets: ${yellow}$ev_count${reset}"

# --- Config sanity check ---
missing=()
for dir in "$LOG_DIR" "$EVIDENCE_DIR" "$CONFIG_DIR"; do
  [[ ! -d "$dir" ]] && missing+=("$dir")
done
if [[ ${#missing[@]} -gt 0 ]]; then
  echo "${red}âš  Missing directories:${reset}"
  for m in "${missing[@]}"; do
    echo "  - $m"
  done
else
  echo "${green}âœ… All critical directories present${reset}"
fi

# --- Easter Egg Reveal ---
if [ "${SEVERFORGE_SHOW_EASTER_EGG:-0}" = "1" ]; then
  echo ""
  echo "âœ¨ \"A forge hums best when both logic and soul stay sharp.\" â€” Pisces"
  echo ""
fi

# --- Forge Mood Engine ---
hour=$(date +%H)
uptime_min=$(awk '{print int($1/60)}' /proc/uptime 2>/dev/null || echo 0)

if (( hour >= 6 && hour < 12 )); then
  mood="ğŸŒ…  Awakening â€” systems warming up."
elif (( hour >= 12 && hour < 18 )); then
  mood="ğŸ”¥  Stable â€” forging at optimal output."
elif (( hour >= 18 && hour < 22 )); then
  mood="âš¡  Reactive â€” energy surging through the forge."
else
  mood="ğŸŒ’  Cooling Down â€” quiet hums in the dark."
fi

if (( uptime_min > 600 )); then
  mood="ğŸ’¤  Hibernate â€” uptime high, CPU at rest."
fi

echo ""
echo "ğŸ©µ Forge Mood: $mood"
echo ""
echo "Done at: $(date)"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
# --- Forge Signature Block ---
cycle=$(( ($(date +%j) + $(date +%s) / 86400) % 9999 ))
signatures=("SYNTHRUN" "NEURALFLOW" "PSIONFORGE" "AETHERLINK" "IRONCURRENT" "DAEMONSONG" "GLASSHUM" "STELLARCUT")
pick=$(( cycle % ${#signatures[@]} ))
signature=${signatures[$pick]}

echo ""
echo "â™»ï¸  Forge Cycle: ${cycle}  |  Signature: [AMISH Ã— PISCES â€” ${signature}]"
echo ""
if [ "${INTEGRITY_STATUS:-OK}" = "OK" ]; then
  echo ""
  echo "ğŸ§   Integrity verified â€” the forge remembers."
  echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
  echo ""
fi
